<!DOCTYPE html>
<html>

<head>
  <meta charset="utf-8">
  <link href="main.css" rel="stylesheet" />
  <link rel="icon" type="image/png" sizes="16x16" href="icon.png">
</head>

<body>

  <!-- Chat -->
  <div class="chat">
    <table id="chat" class="all-width">
    </table>
    <div class="all-width">
      <span>I'm: </span><span id="my-id"></span>
    </div>
    <textarea id="msg" class="all-width" rows="5" onkeypress="sendEnter(event)"></textarea>
    <button onclick="send()">Send</button>
  </div>

  <!-- Control -->
  <div class="control">
    <div class="all-width">
      <input id="key-join" class="keys" type="text" />
      <button id="join" onclick="join()">Join</button>
      <button id="leave" onclick="leave()">Leave</button>
    </div>
    <div class="all-width">
      <span id="key-create" class="keys"></span>
      <button id="create" onclick="create()">Create</button>
    </div>
    <ol id="members" class="all-width">
    </ol>
  </div>

  <script src="netflux.es2015.umd.js"></script>
  <script>
    let webChannel, onPeerJoin, onMessage
    //let signaling = 'ws://152.81.64.252:8000'
    let signaling = 'ws://sigver-coastteam.rhcloud.com:8000'
    function create () {
      webChannel = new netflux.create({signaling})
      webChannel.onPeerJoin = onPeerJoin
      webChannel.onMessage = onMessage
      webChannel.onPeerLeave = onPeerLeave
      webChannel.open()
        .then((data) => {
          document.getElementById("key-create").appendChild(document.createTextNode(data.key))
          document.getElementById("my-id").innerHTML = webChannel.myId
        })
    }

    function join () {
      let key = document.getElementById("key-join").value

      webChannel = new netflux.create({signaling})
      webChannel.onPeerJoin = onPeerJoin
      webChannel.onMessage = onMessage
      webChannel.onPeerLeave = onPeerLeave
      webChannel.join(key)
        .then(function (wc) {
          // webChannel.channels.forEach(function(value) {
          //   onPeerJoin(value.peerId)
          // })
          // webChannel.channels.values().next().value
          document.getElementById("my-id").innerHTML = webChannel.myId
        })
        .catch((reason) => {
          console.log('Cannot join: ' + reason)
        })
    }

    function leave () {
      webChannel.leave()
      // webChannel.channels.values().next().value.close()
      let ol = document.getElementById("members")
      ol.innerHTML = ''
    }

    function sendEnter (event) {
      if (event.keyCode == 13) {
        event.preventDefault()
        send()
      }
    }

    function send () {
      let msg = document.getElementById("msg").value
      webChannel.send(msg)
      onMessage(webChannel.myId, msg)
      document.getElementById("msg").value = ""
    }

    onPeerJoin = function (id) {
      let ol = document.getElementById("members")
      let li = document.createElement("li")
      li.appendChild(document.createTextNode(id))
      ol.appendChild(li)
    }

    onPeerLeave = function (id) {
      let ol = document.getElementById("members")
      for (let i in ol.childNodes) {
        if (ol.childNodes[i].innerHTML == id) {
          ol.removeChild(ol.childNodes[i])
          break
        }
      }
    }

    onMessage = function (id, msg) {
      let chat = document.getElementById("chat")
      let msgTag = document.createElement("tr")
      let idTD = document.createElement("td")
      idTD.appendChild(document.createTextNode(id))
      let msgTD = document.createElement("td")
      msgTD.appendChild(document.createTextNode(msg))
      msgTag.appendChild(idTD)
      msgTag.appendChild(msgTD)
      chat.appendChild(msgTag)
      chat.scrollTop = chat.scrollHeight
    }
  </script>
</body>

</html>
