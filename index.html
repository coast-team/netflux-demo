<!DOCTYPE html>
<html>

<head>
  <meta charset="utf-8">
  <link href="main.css" rel="stylesheet" />
</head>

<body>

  <!-- Chat -->
  <div class="chat">
    <table id="chat" class="all-width">
    </table>
    <div class="all-width">
      <span>I'm: </span><span id="my-id"></span>
    </div>
    <textarea id="msg" class="all-width" rows="5" onkeypress="sendEnter(event)"></textarea>
    <button onclick="send()">Send</button>
  </div>

  <!-- Control -->
  <div class="control">
    <div class="all-width">
      <input id="key-join" class="keys" type="text" />
      <button id="join" onclick="join()">Join</button>
    </div>
    <div class="all-width">
      <span id="key-create" class="keys"></span>
      <button id="create" onclick="create()">Create</button>
    </div>
    <ol id="members" class="all-width">
    </ol>
  </div>

  <script src="netflux.js"></script>
  <script>
    var webChannel, onJoining, onMessage
    function create () {
      webChannel = new nf.WebChannel()
      webChannel.onJoining = onJoining
      webChannel.onMessage = onMessage
      var key = webChannel.openForJoining()
      document.getElementById("key-create").appendChild(document.createTextNode(key))
      document.getElementById("my-id").innerHTML = webChannel.myId
    }

    function join () {
      var key = document.getElementById("key-join").value

      webChannel = new nf.WebChannel()
      webChannel.onJoining = onJoining
      webChannel.onMessage = onMessage
      webChannel.join(key)
        .then(function (wc) {
          webChannel.channels.forEach(function(value) {
            onJoining(value.peerId)
          })
          document.getElementById("my-id").innerHTML = webChannel.myId
        })
    }

    function sendEnter (event) {
      if (event.keyCode == 13) {
        event.preventDefault()
        send()
      }
    }

    function send () {
      var msg = document.getElementById("msg").value
      webChannel.send(msg)
      onMessage(webChannel.myId, msg)
      document.getElementById("msg").value = ""
    }

    onJoining = function (id) {
      var ol = document.getElementById("members")
      var li = document.createElement("li")
      li.appendChild(document.createTextNode(id))
      ol.appendChild(li)
    }

    onMessage = function (id, msg) {
      var chat = document.getElementById("chat")
      var msgTag = document.createElement("tr")
      var idTD = document.createElement("td")
      idTD.appendChild(document.createTextNode(id))
      var msgTD = document.createElement("td")
      msgTD.appendChild(document.createTextNode(msg))
      msgTag.appendChild(idTD)
      msgTag.appendChild(msgTD)
      chat.appendChild(msgTag)
      chat.scrollTop = chat.scrollHeight
    }
  </script>
</body>

</html>
